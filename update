#!/bin/bash
version="1.1.0"

if [ $EUID -ne 0 ]; then
    echo "Error: Root user is required to execute.."
    exit 1
fi

apt-security() {
    tmp_list=$(mktemp /tmp/update-XXXX)
    list=/etc/apt/sources.list

    if [ -z $list ]; then
        return
    fi

    grep "security" $list | grep -v "src" | cut -d "#" -f 2 | head -n1 > $tmp_list

    apt upgrade -V -o Dir::Etc::SourceList=$tmp_list
    rm $tmp_list
}

sources() {
    # if no filename given
    if [ -z $1 ]; then
        # create array with all available files
        lists=$(find /etc/apt/ -type f -iname *.list -printf "%f\n")

        # fix lists in array and print them
        i=1
        for f in ${lists[@]}; do
            lists[$i]="$f"
            echo "$i) ${lists[$i]}"
            ((i++))
        done

        # Empty current list so everytime list is fresh and 0 is invalid
        unset lists[0]
        lists[$i]="Return Back"
        echo -e "$i) ${lists[$i]}\n"
        read -p "Enter source list number [1]: " i

        case ${lists[$i]} in
            '') echo -e "Error: No source list found. Must be number within range."
                return ;;
            "Return Back") return ;;
        esac

        # Set list name to edit
        list="${lists[$i]}"

    # in case filename is given check if file exists
    elif [[ -f $(find /etc/apt/ -type f -iname $1) ]]; then
        list=$1
    else
        echo -e "Error: $1 file not found, try again..."
        return
    fi

    # apt tries to create new file in case of sources.list
    if [ $list == "sources.list" ]; then
        unset list
    fi
    apt edit-sources $list

    read -p "Update package repositories now? [Y/n]: "
    case $REPLY in
        y|Y|'') apt update -qq ;;
        *) echo "Repositories not updated" ;;
    esac
}

vers() {
    echo -e "System-Update\nVersion: "$version
    echo -e "Github page: https://github.com/sianios/system-update"
}

help() {
    cat <<EOF
1) Update
2) Upgrade
3) Full-Upgrade
s) Upgrade security packages
l) List available Upgrades
a) Autoremove
c) Clean
e) Edit sources list files
h) View apt history log
m) Print help menu
v) Version
q) Exit
EOF
}

welcome() {
    if [ -z $flag ]; then
        echo -e "Welcome to Systerm Update Script!\n"
        flag=1
    fi
}

main() {
    case $1 in
        1) apt update -qq ;;
        2) apt upgrade -V -qq ;;
        3) apt full-upgrade -V -qq ;;
        s) apt-security ;;
        l) apt list --upgradable ;;
        a) apt autoremove --purge ;;
        c) apt clean ;;
        e) sources $2 ;;
        h) less -N /var/log/apt/history.log ;;
        m) help ;;
        v) vers ;;
        q) exit 0 ;;
        ?*) echo "Error: $1 option not available, try again..." ;;
    esac
}

while true; do

    if [ -z $1 ]; then
        welcome
        read -p "Enter option (m - menu): "
        main $REPLY
    else
        main ${1//-} $2
        break
    fi

done
